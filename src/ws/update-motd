#!/bin/bash -e

# syntax: update-motd [port [hostname [protocol]]]
# each argument can be given as the empty string to use the default

# hostname from cmdline, then `hostname -f`
hostname=${2:-$(hostname -f || hostname)}

# protocol from cmdline, then https
protocol=${3:-https}

printf 'Web console: \n' > /run/cockpit/active.motd
# make newlines the only separator
# IFS=$'\n'
# port number from cmdline, then systemctl file
for line in ${1:-$(systemctl show --value --property Listen cockpit.socket)}; do
    port=${line##*:}
    if [[ $port =~ [0-9]+ ]]; then
        hostname_url="${protocol}://${hostname}:${port}/"
        printf '%s\n' "${hostname_url}" >> /run/cockpit/active.motd
    fi
done
printf '\n' >> /run/cockpit/active.motd
